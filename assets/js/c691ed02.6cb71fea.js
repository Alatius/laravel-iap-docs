"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[9781],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var i=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function a(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n,i,r={},s=Object.keys(e);for(i=0;i<s.length;i++)n=s[i],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(i=0;i<s.length;i++)n=s[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=i.createContext({}),l=function(e){var t=i.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=l(e.components);return i.createElement(p.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},d=i.forwardRef((function(e,t){var n=e.components,r=e.mdxType,s=e.originalType,p=e.parentName,c=a(e,["components","mdxType","originalType","parentName"]),d=l(n),m=r,h=d["".concat(p,".").concat(m)]||d[m]||u[m]||s;return n?i.createElement(h,o(o({ref:t},c),{},{components:n})):i.createElement(h,o({ref:t},c))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=n.length,o=new Array(s);o[0]=d;var a={};for(var p in t)hasOwnProperty.call(t,p)&&(a[p]=t[p]);a.originalType=e,a.mdxType="string"==typeof e?e:r,o[1]=a;for(var l=2;l<s;l++)o[l]=n[l];return i.createElement.apply(null,o)}return i.createElement.apply(null,n)}d.displayName="MDXCreateElement"},4078:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>u,frontMatter:()=>s,metadata:()=>a,toc:()=>l});var i=n(7462),r=(n(7294),n(3905));const s={sidebar_position:3,description:"Learn how to use liap event listeners."},o="Event Listeners",a={unversionedId:"get-started/event-listeners",id:"get-started/event-listeners",title:"Event Listeners",description:"Learn how to use liap event listeners.",source:"@site/docs/get-started/event-listeners.mdx",sourceDirName:"get-started",slug:"/get-started/event-listeners",permalink:"/laravel-iap-docs/docs/get-started/event-listeners",draft:!1,editUrl:"https://github.com/imdhemy/laravel-iap-docs/blob/master/docs/get-started/event-listeners.mdx",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3,description:"Learn how to use liap event listeners."},sidebar:"tutorialSidebar",previous:{title:"Routing",permalink:"/laravel-iap-docs/docs/get-started/routing"},next:{title:"Server Notifications",permalink:"/laravel-iap-docs/docs/category/server-notifications"}},p={},l=[{value:"Creating an Event Listener",id:"creating-an-event-listener",level:2},{value:"Accessing the Event Data",id:"accessing-the-event-data",level:2},{value:"Handling an event example",id:"handling-an-event-example",level:2}],c={toc:l};function u(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,i.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"event-listeners"},"Event Listeners"),(0,r.kt)("p",null,"If you enabled the ",(0,r.kt)("a",{parentName:"p",href:"docs/category/server-notifications"},"server notifications"),"\non your IAP provider CP, LIAP will trigger a purchase event once a\nnotification is received."),(0,r.kt)("h2",{id:"creating-an-event-listener"},"Creating an Event Listener"),(0,r.kt)("p",null,"Your application should create an event listener to handle the different\nstates of the subscription life cycle. Each state update will trigger a\nspecific event which you can listen to as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="app\\Listeners\\AutoRenewSubscription.php"',title:'"app\\Listeners\\AutoRenewSubscription.php"'},"namespace App\\Listeners;\n\nuse Imdhemy\\Purchases\\Events\\GooglePlay\\SubscriptionRenewed;\n\nclass AutoRenewSubscription\n{\n  /**\n  * Auto-renews the subscription.\n  *\n  * @param SubscriptionRenewed $event\n  * @return void\n  */\n  public function handle(SubscriptionRenewed $event) {\n    // Do something with the subscription\n  }\n}\n\n")),(0,r.kt)("p",null,"Add the created listener to the associated event key."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="config/liap.php"',title:'"config/liap.php"'},"\n[\n  // .. Other configurations are trimmed out for brevity\n  'eventListeners' => [\n    SubscriptionRenewed::class => [\\App\\Listeners\\AutoRenewSubscription::class],\n  ],\n]\n\n")),(0,r.kt)("h2",{id:"accessing-the-event-data"},"Accessing the Event Data"),(0,r.kt)("p",null,"All triggered events implement\n",(0,r.kt)("inlineCode",{parentName:"p"},"Imdhemy\\Purchases\\Contracts\\PurchaseEventContract")," interface, which allows\nyou to access to the notification data through the ",(0,r.kt)("inlineCode",{parentName:"p"},"getServerNotification()")," method."),(0,r.kt)("p",null,"The server notification in turn gives you access to the related subscription\nthrough the ",(0,r.kt)("inlineCode",{parentName:"p"},"getSubscription()")," method."),(0,r.kt)("p",null,"The subscription instance gives you access to the following methods:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("inlineCode",{parentName:"li"},"getExpiryTime()")," returns a ",(0,r.kt)("inlineCode",{parentName:"li"},"Time")," instance representing the subscription\nexpiry time."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("inlineCode",{parentName:"li"},"getItemId()")," returns the subscription identifier."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("inlineCode",{parentName:"li"},"getProvider()")," returns the subscription provider. (",(0,r.kt)("inlineCode",{parentName:"li"},"app_store")," or\n",(0,r.kt)("inlineCode",{parentName:"li"},"google_play"),")."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("inlineCode",{parentName:"li"},"getUniqueIdentifier()")," returns the subscription unique identifier. Learn\nmore about customizing the subscription unique identifiers in the\n",(0,r.kt)("a",{parentName:"li",href:"/docs/get-started/installation#unique-identifiers"},"configuration")," section."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("inlineCode",{parentName:"li"},"getProviderRepresentation()")," returns the subscription provider original\nrepresentation. This is useful for accessing extra subscription data if\nrequired.")),(0,r.kt)("h2",{id:"handling-an-event-example"},"Handling an event example"),(0,r.kt)("p",null,"Below is an example of how to handle an incoming purchase event:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="app\\Listeners\\AutoRenewSubscription.php"',title:'"app\\Listeners\\AutoRenewSubscription.php"'},"namespace App\\Listeners;\n\nuse Imdhemy\\Purchases\\Events\\GooglePlay\\SubscriptionRenewed;\nuse App\\Repositories\\SubscriptionRepository;\nuse App\\User;\n\nclass AutoRenewSubscription\n{\n     /**\n      * @param SubscriptionRepository\n      */\n     public function __construct(SubscriptionRepository $subscriptionRepository)\n     {\n         $this->subscriptionRepository = $subscriptionRepository;\n     }\n\n    /**\n    * Auto-renews the subscription.\n    *\n    * @param SubscriptionRenewed $event\n    * @return void\n    */\n    public function handle(SubscriptionRenewed $event)\n    {\n       // The following data can be retrieved from the event\n       $subscription = $event->getServerNotification()->getSubscription();\n       $uniqueIdentifier = $subscription->getUniqueIdentifier();\n       $expirationTime = $subscription->getExpiryTime();\n\n       // The following steps are up to you, this is only an imagined scenario.\n       $subscription = $this->subscriptionRepository->find($uniqueIdentifier);\n       $subscription->setExpiryTime($expirationTime->getCarbon());\n       $subscription->save();\n\n        // Let's say you want to send a notification to the user\n       $this->notifyUserAboutUpdate($subscription->getUser());\n    }\n\n    /**\n     * Notify the user about the subscription update.\n     *\n     * @param User $user\n     * @return void\n     */\n    private function notifyUserAboutUpdate($user)\n    {\n        // Send an email to the user\n    }\n}\n")))}u.isMDXComponent=!0}}]);